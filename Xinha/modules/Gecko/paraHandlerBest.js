/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
EnterParagraphs._pluginInfo={name:"EnterParagraphs",version:"1.0",developer:"Adam Wright",developer_url:"http://www.hipikat.org/",sponsor:"The University of Western Australia",sponsor_url:"http://www.uwa.edu.au/",license:"htmlArea"};EnterParagraphs.prototype._whiteSpace=/^\s*$/;EnterParagraphs.prototype._pExclusions=/^(address|blockquote|body|dd|div|dl|dt|fieldset|form|h1|h2|h3|h4|h5|h6|hr|li|noscript|ol|p|pre|table|ul)$/i;EnterParagraphs.prototype._pContainers=/^(body|del|div|fieldset|form|ins|map|noscript|object|td|th)$/i;EnterParagraphs.prototype._pBreak=/^(address|pre|blockquote)$/i;EnterParagraphs.prototype._permEmpty=/^(area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$/i;EnterParagraphs.prototype._elemSolid=/^(applet|br|button|hr|img|input|table)$/i;EnterParagraphs.prototype._pifySibling=/^(address|blockquote|del|div|dl|fieldset|form|h1|h2|h3|h4|h5|h6|hr|ins|map|noscript|object|ol|p|pre|table|ul|)$/i;EnterParagraphs.prototype._pifyForced=/^(ul|ol|dl|table)$/i;EnterParagraphs.prototype._pifyParent=/^(dd|dt|li|td|th|tr)$/i;function EnterParagraphs(b){this.editor=b;if(Xinha.is_gecko){this.onKeyPress=this.__onKeyPress}}EnterParagraphs.prototype.name="EnterParagraphs";EnterParagraphs.prototype.insertAdjacentElement=function(f,e,d){if(e=="BeforeBegin"){f.parentNode.insertBefore(d,f)}else{if(e=="AfterEnd"){f.nextSibling?f.parentNode.insertBefore(d,f.nextSibling):f.parentNode.appendChild(d)}else{if(e=="AfterBegin"&&f.firstChild){f.insertBefore(d,f.firstChild)}else{if(e=="BeforeEnd"||e=="AfterBegin"){f.appendChild(d)}}}}};EnterParagraphs.prototype.forEachNodeUnder=function(i,g,k,h){var l,j;if(i.nodeType==11&&i.firstChild){l=i.firstChild;j=i.lastChild}else{l=j=i}while(j.lastChild){j=j.lastChild}return this.forEachNode(l,j,g,k,h)};EnterParagraphs.prototype.forEachNode=function(o,v,m,s,t){var u=function(b,a){return(a=="ltr"?b.nextSibling:b.previousSibling)};var x=function(b,a){return(a=="ltr"?b.firstChild:b.lastChild)};var w,n,p;var r=t;var q=false;while(w!=s=="ltr"?v:o){if(!w){w=s=="ltr"?o:v}else{if(x(w,s)){w=x(w,s)}else{if(u(w,s)){w=u(w,s)}else{n=w;while(!u(n,s)&&n!=(s=="ltr"?v:o)){n=n.parentNode}w=(u(n,s)?u(n,s):n)}}}q=(w==(s=="ltr"?v:o));switch(m){case"cullids":p=this._fenCullIds(w,r);break;case"find_fill":p=this._fenEmptySet(w,r,m,q);break;case"find_cursorpoint":p=this._fenEmptySet(w,r,m,q);break}if(p[0]){return p[1]}if(q){break}if(p[1]){r=p[1]}}return false};EnterParagraphs.prototype._fenEmptySet=function(f,g,e,h){if(!g&&!f.firstChild){g=f}if((f.nodeType==1&&this._elemSolid.test(f.nodeName))||(f.nodeType==3&&!this._whiteSpace.test(f.nodeValue))||(f.nodeType!=1&&f.nodeType!=3)){switch(e){case"find_fill":return new Array(true,false);break;case"find_cursorpoint":return new Array(true,f);break}}if(h){return new Array(true,g)}return new Array(false,g)};EnterParagraphs.prototype._fenCullIds=function(e,d,f){if(d.id){f[d.id]?d.id="":f[d.id]=true}return new Array(false,f)};EnterParagraphs.prototype.processSide=function(l,j){var i=function(b,a){return(a=="left"?b.previousSibling:b.nextSibling)};var h=j=="left"?l.startContainer:l.endContainer;var n=j=="left"?l.startOffset:l.endOffset;var k,m=h;while(m.nodeType==1&&!this._permEmpty.test(m.nodeName)){m=(n?m.lastChild:m.firstChild)}while(k=k?(i(k,j)?i(k,j):k.parentNode):m){if(i(k,j)){if(this._pExclusions.test(i(k,j).nodeName)){return this.processRng(l,j,k,i(k,j),(j=="left"?"AfterEnd":"BeforeBegin"),true,false)}}else{if(this._pContainers.test(k.parentNode.nodeName)){return this.processRng(l,j,k,k.parentNode,(j=="left"?"AfterBegin":"BeforeEnd"),true,false)}else{if(this._pExclusions.test(k.parentNode.nodeName)){if(this._pBreak.test(k.parentNode.nodeName)){return this.processRng(l,j,k,k.parentNode,(j=="left"?"AfterBegin":"BeforeEnd"),false,(j=="left"?true:false))}else{return this.processRng(l,j,(k=k.parentNode),(i(k,j)?i(k,j):k.parentNode),(i(k,j)?(j=="left"?"AfterEnd":"BeforeBegin"):(j=="left"?"AfterBegin":"BeforeEnd")),false,false)}}}}}};EnterParagraphs.prototype.processRng=function(s,y,q,C,x,u,w){var B=y=="left"?s.startContainer:s.endContainer;var z=y=="left"?s.startOffset:s.endOffset;var E=this.editor;var v=E._doc.createRange();v.selectNode(q);if(y=="left"){v.setEnd(B,z);s.setStart(v.startContainer,v.startOffset)}else{if(y=="right"){v.setStart(B,z);s.setEnd(v.endContainer,v.endOffset)}}var D=v.cloneContents();this.forEachNodeUnder(D,"cullids","ltr",this.takenIds,false,false);var t,A,F;t=y=="left"?(v.endContainer.nodeType==3?true:false):(v.startContainer.nodeType==3?false:true);A=t?v.startOffset:v.endOffset;t=t?v.startContainer:v.endContainer;if(this._pifyParent.test(t.nodeName)&&t.parentNode.childNodes.item(0)==t){while(!this._pifySibling.test(t.nodeName)){t=t.parentNode}}if(D.nodeType==11&&!D.firstChild){if(t.nodeName!="BODY"||(t.nodeName=="BODY"&&A!=0)){D.appendChild(E._doc.createElement(t.nodeName))}}F=this.forEachNodeUnder(D,"find_fill","ltr",false);if(F&&this._pifySibling.test(t.nodeName)&&((A==0)||(A==1&&this._pifyForced.test(t.nodeName)))){q=E._doc.createElement("p");q.innerHTML="&nbsp;";if((y=="left")&&t.previousSibling){return new Array(t.previousSibling,"AfterEnd",q)}else{if((y=="right")&&t.nextSibling){return new Array(t.nextSibling,"BeforeBegin",q)}else{return new Array(t.parentNode,(y=="left"?"AfterBegin":"BeforeEnd"),q)}}}if(F){if(F.nodeType==3){F=E._doc.createDocumentFragment()}if((F.nodeType==1&&!this._elemSolid.test())||F.nodeType==11){var r=E._doc.createElement("p");r.innerHTML="&nbsp;";F.appendChild(r)}else{var r=E._doc.createElement("p");r.innerHTML="&nbsp;";F.parentNode.insertBefore(parentNode,F)}}if(F){q=F}else{q=(u||(D.nodeType==11&&!D.firstChild))?E._doc.createElement("p"):E._doc.createDocumentFragment();q.appendChild(D)}if(w){q.appendChild(E._doc.createElement("br"))}return new Array(C,x,q)};EnterParagraphs.prototype.isNormalListItem=function(d){var e,f;e=d.startContainer;if((typeof e.nodeName!="undefined")&&(e.nodeName.toLowerCase()=="li")){f=e}else{if((typeof e.parentNode!="undefined")&&(typeof e.parentNode.nodeName!="undefined")&&(e.parentNode.nodeName.toLowerCase()=="li")){f=e.parentNode}else{return false}}if(!f.previousSibling){if(d.startOffset==0){return false}}return true};EnterParagraphs.prototype.__onKeyPress=function(b){if(b.keyCode==13&&!b.shiftKey&&this.editor._iframe.contentWindow.getSelection){return this.handleEnter(b)}};EnterParagraphs.prototype.handleEnter=function(e){var q;var n=this.editor.getSelection();var r=this.editor.createRange(n);if(this.isNormalListItem(r)){return true}this.takenIds=new Object();var l=this.processSide(r,"left");var o=this.processSide(r,"right");q=o[2];n.removeAllRanges();r.deleteContents();var m=this.forEachNodeUnder(q,"find_cursorpoint","ltr",false,true);if(!m){alert("INTERNAL ERROR - could not find place to put cursor after ENTER")}if(l){this.insertAdjacentElement(l[0],l[1],l[2])}if(o&&o.nodeType!=1){this.insertAdjacentElement(o[0],o[1],o[2])}if((m)&&(this._permEmpty.test(m.nodeName))){var p=0;while(m.parentNode.childNodes.item(p)!=m){p++}n.collapse(m.parentNode,p)}else{try{n.collapse(m,0);if(m.nodeType==3){m=m.parentNode}this.editor.scrollToElement(m)}catch(k){}}this.editor.updateToolbar();Xinha._stopEvent(e);return true};