/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
function InsertNote(e){this.editor=e;var d=e.config;var f=this;d.registerButton({id:"insert-note",tooltip:this._lc("Insert footnote"),image:e.imgURL("insert-note.gif","InsertNote"),textMode:false,action:function(){f.show()}});d.addToolbarElement("insert-note","createlink",1)}InsertNote._pluginInfo={name:"InsertNote",version:"0.4",developer:"Nicholas Bergson-Shilcock",developer_url:"http://www.nicholasbs.com",c_owner:"Nicholas Bergson-Shilcock",sponsor:"The Open Planning Project",sponsor_url:"http://topp.openplans.org",license:"LGPL"};InsertNote.prototype.onGenerateOnce=function(){this.notes={};this.noteNums={};this.ID_PREFIX="InsertNoteID_";this.MARKER_SUFFIX="_marker";this.MARKER_CLASS="InsertNoteMarker";this.LINK_BACK_SUFFIX="_LinkBacks";this.NOTE_LIST_ID="InsertNote_NoteList";this._prepareDialog()};InsertNote.prototype._prepareDialog=function(){var c=this;var d=this.editor;if(!this.html){Xinha._getback(Xinha.getPluginDir("InsertNote")+"/dialog.html",function(a){c.html=a;c._prepareDialog()});return}this.dialog=new Xinha.Dialog(d,this.html,"InsertNote",{width:400,closeOnEscape:true,resizable:false,centered:true,modal:true});this.dialog.getElementById("ok").onclick=function(){c.apply()};this.dialog.getElementById("cancel").onclick=function(){c.dialog.hide()};this.dialog.getElementById("noteMenu").onchange=function(){var a=this.options[this.selectedIndex].value;var b=c.notes[a]||"";var f=c.dialog.getElementById("noteContent");f.value=b;if(b){f.disabled=true}else{f.disabled=false;f.focus()}};this.ready=true};InsertNote.prototype.show=function(){if(!this.ready){var n=this;window.setTimeout(function(){n.show()},80);return}var l=this.editor;var p=document;this.repairNotes();if(this.cursorInFootnote()){alert("Footnotes cannot be inserted inside of other footnotes.");return}this.dialog.show();var q=this.dialog.getElementById("noteMenu");while(q.lastChild.value!="new"){q.removeChild(q.lastChild)}var o,r,i;var m=this._getOrderedNoteIds();for(var t=0;t<m.length;t++){i=m[t];o=p.createElement("option");o.setAttribute("value",i);r=this.notes[i];r=r.replace(/<[^>]*>/gi,"");if(r.length>50){r=r.substr(0,50)+"..."}r=this._getNumFromNoteId(i)+". "+r;o.appendChild(p.createTextNode(r));q.appendChild(o)}var s=this.dialog.getElementById("noteContent");s.disabled=false;s.focus();s.value=""};InsertNote.prototype.cursorInFootnote=function(f){var d=this.editor.getAllAncestors();for(var e=0;e<d.length;e++){if(d[e].id==this.NOTE_LIST_ID){return true}if(d[e].className==this.MARKER_CLASS&&!f){return true}}return false};InsertNote.prototype.repairNotes=function(){var s=this;var v;var o;var p;var i;var t;var u=this.editor._doc;this.repairScheduled=false;o=this._getMarkers();for(var n=0;n<o.length;n++){p=o[n];i=false;if(p){i=p.innerHTML.match(/^(<span[^>]*>)?(<sup>)?(<a[^>]*>)?[\s]*(<\/a>)?(<\/sup>)?(<\/span>)?$/m)}if(i){p.parentNode.removeChild(p)}var w=this._getIdFromMarkerId(p.id);if(!this.notes[w]){v=u.getElementById(w);if(v){this._saveNote(v)}else{if(p){p.parentNode.removeChild(p)}}}}for(var r in this.notes){v=u.getElementById(r);o=this._getMarkers(r);if(v){if(o.length==0){v.parentNode.removeChild(v);delete this.notes[r]}else{this._saveNote(v)}}else{for(var n=0;n<o.length;n++){o[n].parentNode.removeChild(o[n])}delete this.notes[r]}}this._updateRefNums();var q=u.getElementById(this.NOTE_LIST_ID);var x=this._createNoteList();if(x){q.parentNode.replaceChild(x,q)}else{if(q){q.parentNode.removeChild(q)}}};InsertNote.prototype._saveNote=function(f){var e=this.editor._doc;var h=e.getElementById(this._getLinkBackSpanId(f.id));if(h){h.parentNode.removeChild(h)}if(f.innerHTML){this.notes[f.id]=f.innerHTML}else{delete this.notes[f.id];markers=this._getMarkers(f.id);for(var g=0;g<markers.length;g++){markers[g].parentNode.removeChild(markers[g])}}};InsertNote.prototype._updateRefNums=function(){var j=1;var h;var l;var i;this.noteNums={};var k=this._getMarkers();for(var g=0;g<k.length;g++){l=k[g];i=this._getIdFromMarkerId(l.id);if(this.noteNums[i]){h=this.noteNums[i]}else{this.noteNums[i]=j;h=j++}l.firstChild.firstChild.innerHTML=h}};InsertNote.prototype.apply=function(){var q=this.editor;var o=this.dialog.hide();var v=o.noteMenu.value;var p=(v=="new");var w=o.noteContent;var s=q._doc;if(p){v=this._getNextId(this.ID_PREFIX)}this.notes[v]=w;var t=this._createNoteMarker(v);q.insertNodeAtSelection(t);var n=s.getElementById(t.id);var u=s.getElementById(this.NOTE_LIST_ID);var x=this._createNoteList();var m=s.body;if(u){m.replaceChild(x,u)}else{m.appendChild(x)}var r=s.createTextNode("\u00a0");if(n.nextSibling){r=n.parentNode.insertBefore(r,n.nextSibling)}else{r=n.parentNode.appendChild(r)}this.repairNotes();q.selectNodeContents(r,false)};InsertNote.prototype._createNoteList=function(){var g=this.editor._doc;var l=g.createElement("ol");l.id=this.NOTE_LIST_ID;var h=this._getOrderedNoteIds();if(h.length==0){return null}var i,k;for(var j=0;j<h.length;j++){k=h[j];i=this._createNoteNode(k,this.notes[k]);l.appendChild(i)}return l};InsertNote.prototype._createNoteMarker=function(i){var l=this.editor._doc;var k=this._getNumFromNoteId(i);var g=l.createElement("a");g.href="#"+i;g.innerHTML=k;var j=l.createElement("sup");j.appendChild(g);var h=l.createElement("span");h.id=this._getNextMarkerId(i);h.className=this.MARKER_CLASS;h.appendChild(j);return h};InsertNote.prototype._createNoteNode=function(r,s){var o=this.editor._doc;var l;var p=o.createElement("sup");var i=this._getMarkers(r);var m;for(var t=0;t<i.length;t++){l=o.createElement("a");if(i.length==1){l.innerHTML="^"}else{l.innerHTML=this._letterNum(t)}l.href="#"+i[t].id;p.appendChild(l);if(t<i.length-1){m=o.createTextNode(", ");p.appendChild(m)}}var q=o.createElement("span");q.id=this._getLinkBackSpanId(r);q.appendChild(p);var n=o.createElement("li");n.id=r;n.innerHTML=s;n.appendChild(q);return n};InsertNote.prototype._getNextId=function(d){var c=Xinha.uniq(d);while(this.editor._doc.getElementById(c)){c=Xinha.uniq(d)}return c};InsertNote.prototype._getOrderedNoteIds=function(){var d=this;var f=new Array();for(var e in this.notes){f.push(e)}f.sort(function(a,b){var c=d._getNumFromNoteId(a);var h=d._getNumFromNoteId(b);return(c-h)});return f};InsertNote.prototype._getNumFromNoteId=function(b){if(!this.noteNums[b]){return 0}return this.noteNums[b]};InsertNote.prototype._getMarkers=function(i){var f=this.editor._doc;var j=Xinha.getElementsByClassName(f,this.MARKER_CLASS);if(!i){return j}var g=new Array();for(var h=0;h<j.length;h++){if(this._getIdFromMarkerId(j[h].id)==i){g.push(j[h])}}return g};InsertNote.prototype._getNextMarkerId=function(b){return this._getNextId(b+this.MARKER_SUFFIX)};InsertNote.prototype._getIdFromMarkerId=function(b){return b.substr(0,b.search(this.MARKER_SUFFIX))};InsertNote.prototype._getLinkBackSpanId=function(b){return b+this.LINK_BACK_SUFFIX};InsertNote.prototype._lc=function(b){return Xinha._lc(b,"InsertNote")};InsertNote.prototype._letterNum=function(h){var j="abcdefghijklmnopqrstuvwxyz";var i=Math.floor(h/j.length)+1;var f="";for(var g=0;g<i;g++){f+=j.substr(h%j.length,1)}return f};InsertNote.prototype.inwardHtml=function(b){return b};InsertNote.prototype.outwardHtml=function(b){this.repairNotes();return this.editor.getHTML()};InsertNote.prototype.onKeyPress=function(c){if(c.keyCode==8||c.keyCode==46){var d=this;if(!this.repairScheduled&&!this.cursorInFootnote(true)){this.repairScheduled=true;window.setTimeout(function(){d.repairNotes()},1000)}}return false};InsertNote.prototype.onMode=function(b){return false};InsertNote.prototype.onBeforeMode=function(b){return false};