/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
(function(l){var i=window.PersistentStorage=function(a){this.editor=a;var b=this};i._pluginInfo={name:"PersistentStorage",version:"1.0",developer:"Douglas Mayle",developer_url:"http://douglas.mayle.org",license:"BSD"};i.prototype._backends={};i.prototype._userconfigs=[];i.prototype._activeBackend="";i.prototype._typeFilter="";i.prototype._viewType="thumbnail";i.prototype.onGenerateOnce=function(){this._prepareDialog()};function j(b,c){var a=new RegExp(" ?"+c+" ?");if(!a.test(b.className)){b.className+=" "+c}}function k(b,c){var a=new RegExp(" ?"+c+" ?");if(a.test(b.className)){b.className=b.className.replace(a," ")}}function g(b,c){var a=new RegExp(" ?"+c+" ?");if(a.test(b.className)){b.className=b.className.replace(a," ")}else{b.className+=" "+c}}i.prototype._registerDocumentUI=function(){if(this._documentEnabled){return}this._documentEnabled=true;var a=this;var b=this.editor;b.config.registerButton({id:"newdocument",tooltip:h._lc("New Document","PersistentStorage"),image:[_editor_url+b.config.imgURL+"ed_buttons_main.png",0,5],textMode:true,action:function(){a.newDocument()}});b.config.registerButton({id:"opendocument",tooltip:h._lc("Open Document","PersistentStorage"),image:[_editor_url+b.config.imgURL+"ed_buttons_main.png",1,5],textMode:true,action:function(){a.openDialog()}});b.config.registerButton({id:"savedocument",tooltip:h._lc("Save Document","PersistentStorage"),image:[_editor_url+b.config.imgURL+"ed_buttons_main.png",9,1],textMode:true,action:function(){a.saveDialog()}});b.config.addToolbarElement("newdocument","fullscreen",1);b.config.addToolbarElement("opendocument","newdocument",1);b.config.addToolbarElement("savedocument","opendocument",1);b._rebuildToolbar()};i.prototype.registerBackend=function(d,a,c,b){this._backends[d]={module:a,config:c,name:d};if(!this._activeBackend){this.setBackend(d)}if(c.capabilities.upload_operations&&c.capabilities.file_operations){this._registerDocumentUI()}if(b){this._userconfigs.push(b);this.configureUser()}this.updatePlacesDisplay()};i.prototype.configureUser=function(){var a=this;for(var d=0;d<this._userconfigs.length;++d){var c=this._userconfigs[d];for(var b in (c.plugins||{})){h.loadPlugin(b,function(){a.editor.registerPlugins([b]);h.refreshPlugin(a.editor.plugins[b].instance);a.editor._rebuildToolbar()},c.plugins[b])}}};i.prototype.newDocument=function(){if(this.editor._doc.body.lastChild){if(!confirm(h._lc("This will erase any unsaved content.  If you're certain, please click OK to continue.","PersistentStorage"))){return}}while(this.editor._doc.body.lastChild){this.editor._doc.body.removeChild(this.editor._doc.body.lastChild)}};i.prototype.saveDialog=function(){var a=this;var c=this.dialog.getElementById("h1");c.innerHTML=h._lc("Save Document","PersistentStorage");var d=this.dialog.getElementById("confirm");d.value=h._lc("Save","PersistentStorage");d.onclick=function(){a.saveDocument()};var b=this.dialog.getElementById("filename");d.disabled=b.value?false:true;b.onkeyup=b.onkeypress=b.onchange=function(){d.disabled=b.value?false:true};this.showDialog({typeFilter:["document","html","text","folder"],styleFor:"documentsave"})};i.prototype.saveDocument=function(){var a=this.editor;var c=this._backends[this._activeBackend].module;var b=this.dialog.getElementById("filename");c.saveDocument(c.viewFilter,b.value,a.getHTML(),function(){c.cache=null});this.dialog.hide()};i.prototype.openDialog=function(){var a=this;var b=this.dialog.getElementById("h1");b.innerHTML=h._lc("Open Document","PersistentStorage");var c=this.dialog.getElementById("confirm");c.value=h._lc("Open","PersistentStorage");c.onclick=function(){a.openDocument()};this.showDialog({typeFilter:["document","html","text","folder"],styleFor:"documentload"})};i.prototype.openDocument=function(){var b=this.editor;var a=this._backends[this._activeBackend].module;a.loadDocument(this.selectedEntry[0],function(c){b.setHTML(c)});this.dialog.hide()};i.prototype.showDialog=function(e){var c=this;if(!this.ready){window.setTimeout(function(){c.showDialog(e)},80);return}k(this.dialog.getElementById("WWW"),"hidden");j(this.dialog.getElementById("namefield"),"hidden");j(this.dialog.getElementById("placeWww"),"hidden");j(this.dialog.getElementById("placeBackend"),"hidden");switch(e.styleFor){case"link":k(this.dialog.getElementById("placeWww"),"hidden");this.updatePlacesDisplay("shared_publish");break;case"insertion":k(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("shared_publish");break;case"documentsave":j(this.dialog.getElementById("WWW"),"hidden");k(this.dialog.getElementById("namefield"),"hidden");k(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("file_operations");break;case"documentload":j(this.dialog.getElementById("WWW"),"hidden");k(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("file_operations");break}var d=this.dialog.getElementById("filters");var a=this.dialog.getElementById("fileList");this._typeFilter=e.typeFilter;var b=this._backends[this._activeBackend].module;this.updateFileBrowser()};i.prototype.displayFilters=function(d,a){var f=this.dialog.getElementById("filters");while(f.lastChild){f.removeChild(f.lastChild)}for(var b=0;b<d.length;++b){var c=document.createElement("option");c.setAttribute("value",d[b].value);if(d[b].value==a){c.setAttribute("selected","selected")}var e=document.createTextNode(d[b].display);c.appendChild(e);f.appendChild(c)}};i.prototype.buildThumbnail=function(c){var b=this;var e=this._backends[this._activeBackend].module;var d=document.createElement("div");d.entry=c;d.className="file";h._addEvent(d,"click",function(m){m=m||window.event;h._stopEvent(m);if(b.selectedEntry){k(b.selectedEntry[1],"selected");if(b.selectedEntry[1]==d){b.selectedEntry=null;return}}b.selectedEntry=[c,d];b.selectedEntry[1].className+=" selected";var n=b.dialog.getElementById("filename");n.value=c.name;var o=b.dialog.getElementById("confirm");o.disabled=false});var r=document.createElement("img");r.className="icon";if(c.$type=="image"){r.className="thumb";r.setAttribute("src",c.URL)}else{if(c.$type=="folder"){r.setAttribute("src",c.thumbURL||c.URL||this.editor.imgURL("images/tango/32x32/places/folder.png"))}else{if(c.$type=="document"){r.setAttribute("src",c.thumbURL||c.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-html.png"))}else{if(c.$type=="html"){r.setAttribute("src",c.thumbURL||c.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-html.png"))}else{if(c.$type=="txt"){r.setAttribute("src",c.thumbURL||c.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-g-generic.png"))}else{r.setAttribute("src",c.thumbURL||c.URL||this.editor.imgURL("images/tango/32x32/mimetypes/x-office-document.png"))}}}}}r=d.appendChild(r);var a=document.createElement("img");a.className="action delete";a.setAttribute("alt",h._lc("Delete","PersistentStorage"));a.setAttribute("title",h._lc("Delete","PersistentStorage"));a.setAttribute("src",this.editor.imgURL("images/tango/16x16/places/user-trash.png"));a=d.appendChild(a);h._addEvent(a,"click",function(m){m=m||window.event;h._stopEvent(m);e.deleteEntry(c,function(n){e.cache=null;if(n){d.parentNode.removeChild(d)}else{alert("Error deleting file "+c.name)}})});var q=document.createElement("p");q.className="filename";var f=document.createTextNode(c.name);f=q.appendChild(f);q=d.appendChild(q);q.onclick=function(m){return function(n){n=n||window.event;h._stopEvent(n);m.style.border="1px solid red";return false}}(q);var p=document.createElement("img");p.className="action copy";p.setAttribute("src",this.editor.imgURL("images/tango/16x16/actions/edit-copy.png"));p.setAttribute("alt",h._lc("Copy","PersistentStorage"));p.setAttribute("title",h._lc("Copy","PersistentStorage"));h._addEvent(p,"click",function(m){m=m||window.event;h._stopEvent(m);e.copyEntry(c,function(n,o){e.cache=null;if(n){d.parentNode.appendChild(b.buildThumbnail(o))}else{alert("Error copying file "+c.name)}})});p=d.appendChild(p);return d};i.prototype.displayBrowser=function(a){var f=this.dialog.getElementById("fileList");while(f.lastChild){f.removeChild(f.lastChild)}var d=this.editor;var e=this;for(var c=0;c<a.length;++c){switch(this._viewType){case"listing":break;case"thumbnail":default:var b=f.appendChild(this.buildThumbnail(a[c]));if(l&&l.ui&&l.ui.draggable&&l.ui.droppable){l(b).draggable({revert:true});if(a[c].$type=="folder"){l(b).droppable({accept:"*",drop:function(m,q){var r=this;q.draggable.each(function(){var p=this;var o=p.entry;var t=e._backends[e._activeBackend].module;t.moveEntry(o,r.entry,function(s){t.cache=null;if(s){p.parentNode.removeChild(p)}else{alert("Error deleting file "+o.name)}})})}})}}}}if(!f.firstChild){var n=document.createTextNode("No files found");f.appendChild(n)}};i.prototype.updateFileBrowser=function(){var a=this;var c=this._backends[this._activeBackend].module;var b=function(e){c.cache=e;var p=c.getFilters(c.cache);var o=true;if(c.viewFilter){for(var f=0;f<p.length;++f){if(p[f].value==c.viewFilter){o=false}}}if(o){c.viewFilter=p[0].value}var d=c.getMetadata(c.cache,c.viewFilter,a._typeFilter);a.dialog.show();a.displayFilters(p,c.viewFilter);a.displayBrowser(d)};if(c.cache){b(c.cache);return}c.loadData(b)};i.prototype._prepareDialog=function(){var a=this;var c=this.editor;if(!this.html){h._getback(h.getPluginDir("PersistentStorage")+"/dialog.html",function(m){a.html=m;a._prepareDialog()});return}this.dialog=new h.Dialog(c,this.html,"PersistentStorage",{width:800,closeOnEscape:true,resizable:true,centered:true,modal:true});this.dialog.getElementById("cancel").onclick=function(){a.dialog.hide()};this.dialog.getElementById("dirCreate").onclick=function(){var n=prompt(h._lc("Please enter the name of the directory you'd like to create.","PersistentStorage"));if(n){var m=a._backends[a._activeBackend].module;m.makeFolder(m.viewFilter,n,function(r){if(r){m.cache=null;a.updateFileBrowser()}})}};var d=this.dialog.getElementById("importlegend");var e=this.dialog.getElementById("import");d.onclick=function(){g(e,"collapsed")};var f=this.dialog.getElementById("WWW");h._addEvent(f,"click",function(n){n=n||window.event;h._stopEvent(n);for(var m=f.parentNode.firstChild;m;m=m.nextSibling){if(1!=m.nodeType){continue}k(m,"selected")}j(f,"selected");j(a.dialog.getElementById("placeBackend"),"hidden");k(a.dialog.getElementById("placeWww"),"hidden")});var o=this.dialog.getElementById("fileList");h._addEvent(o,"click",function(n){for(var m=o.firstChild;m;m=m.nextSibling){k(m,"selected")}});var p=this.dialog.getElementById("filters");p.onchange=function(){var m=a._backends[a._activeBackend].module;m.viewFilter=p.options[p.selectedIndex].value;a.updateFileBrowser()};var b=this.dialog.getElementById("viewType");b.onchange=function(){a._viewType=b.options[b.selectedIndex].value;a.updateFileBrowser()};this.ready=true};i.prototype.updatePlacesDisplay=function(f){var a=this;var e=this.dialog.getElementById("placesList");while(e.firstChild&&3==e.firstChild.nodeType){e.removeChild(e.firstChild)}var b=e.firstChild;while(b.nextSibling){e.removeChild(b.nextSibling)}for(var d in this._backends){if(f&&!this._backends[d].config.capabilities[f]){continue}var c=e.appendChild(this.placesIcon(this._backends[d]));if(l&&l.ui&&l.ui.draggable&&l.ui.droppable){l(c).droppable({accept:"*",drop:function(p,q){var r=this;q.draggable.each(function(){var m=this;var o=m.entry;var n=a._backends[a._activeBackend].module;n.loadDocument(o,function(t){r.backend.module.saveDocument(n.viewFilter,o.name,t,function(){r.backend.module.cache=null;n.deleteEntry(o,function(s){n.cache=null;if(s){m.parentNode.removeChild(m)}else{alert("Error deleting file "+o.name)}})})})})}})}}};i.prototype.setBackend=function(a){if(this._activeBackend==a){return}this._activeBackend=a;var b=this._backends[this._activeBackend];if(b.config.capabilities.import_operations){h._removeClass(this.dialog.getElementById("import"),"hidden");var c=this.dialog.getElementById("importui");while(c.firstChild){c.removeChild(c.firstChild)}b.module.buildImportUI(this.dialog,c)}else{h._addClass(this.dialog.getElementById("import"),"hidden")}};i.prototype.placesIcon=function(a){var c=this;var f=document.createElement("div");f.backend=a;f.className="file";if(this._activeBackend==a.name){f.className+=" selected"}h._addEvent(f,"click",function(o){o=o||window.event;h._stopEvent(o);for(var p=f.parentNode.firstChild;p;p=p.nextSibling){if(1!=p.nodeType){continue}k(p,"selected")}j(f,"selected");k(c.dialog.getElementById("placeBackend"),"hidden");j(c.dialog.getElementById("placeWww"),"hidden");c.setBackend(a.name);c.updateFileBrowser()});var e=document.createElement("img");e.className="icon";e.setAttribute("src",a.config.thumbURL||this.editor.imgURL("images/tango/32x32/places/network-server.png"));e=f.appendChild(e);var b=document.createElement("p");b.className="filename";var d=document.createTextNode(a.config.displayName||a.name);d=b.appendChild(d);b=f.appendChild(b);return f};var h=window.Xinha;h.prototype._insertImage=function(a){var c=this;var d=c.plugins.PersistentStorage.instance;var e=d.dialog.getElementById("h1");e.innerHTML=h._lc("Insert Image","PersistentStorage");var b=d.dialog.getElementById("confirm");b.value=h._lc("Insert","PersistentStorage");b.onclick=function(){d.insertImage()};d.showDialog({typeFilter:["image","folder"],styleFor:"insertion"})};i.prototype.insertImage=function(){var b=this.editor;this.dialog.hide();var a=b._doc.createElement("img");if(this.selectedEntry){a.setAttribute("src",this.selectedEntry[0].URL)}else{a.setAttribute("src",this.dialog.getElementById("URL").value)}for(var d in {width:"",height:"",margin:"",padding:"",border:"",borderColor:"",backgroundColor:""}){var e=this.dialog.getElementById("image_"+d).value.replace(/^\s+$/,"");if(e){a.style[d]=e}}b.insertNodeAtSelection(a);var c=b.createRange(b.getSelection());c.collapse(false)}})(window.jQuery);